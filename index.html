<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ - æœ€ç»ˆç‰ˆ v2</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
  authDomain: "tile-management-system-f5db8.firebaseapp.com",
  databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
  projectId: "tile-management-system-f5db8",
  storageBucket: "tile-management-system-f5db8.appspot.com",
  messagingSenderId: "925027091187",
  appId: "1:925027091187:web:a2bb160b629f541abded86"
};
try {
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const stockRef = ref(database, 'tileStock');
  window.firebase = { app, database, ref, set, onValue, get, stockRef };
  window.firebaseInitialized = true;
} catch(e){ window.firebaseInitialized=false; window.firebaseError=e.message; }
</script>
<style>
:root{
  --primary:#007AFF;
  --bg:#F8FAFC;
  --card:#fff;
  --radius:14px;
  --shadow:0 6px 18px rgba(0,0,0,0.08);
  --red:#ef4444;
  --orange:#f59e0b;
  --lightgreen:#10b981;
  --green:#047857;
  font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);padding:84px 12px 20px;-webkit-font-smoothing:antialiased;color:#111}
.navbar{
  position:fixed;top:0;left:0;right:0;height:72px;
  backdrop-filter: blur(12px);
  background:rgba(0,122,255,0.82);
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;color:white;z-index:999;border-bottom:1px solid rgba(255,255,255,0.12);
}
.navbar .brand{display:flex;align-items:center;gap:10px}
.navbar h1{font-size:17px;margin:0;font-weight:600}
.nav-tabs{display:flex;gap:6px;align-items:center}
.nav-tabs button{background:transparent;border:0;color:rgba(255,255,255,0.95);font-size:15px;padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center}
.nav-tabs button .icon{font-size:17px}
.nav-tabs button.active{background:rgba(255,255,255,0.12)}
.container{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
h3{color:var(--primary);margin:0 0 6px}
.thai{color:#666;font-size:13px;margin-bottom:8px}
.label-small{font-size:13px;color:#666;margin-bottom:6px}
input,select,textarea,button{font-size:15px}
input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef9}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
button.primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.ghost{background:#f6f9ff;border:1px solid #e6eef9;color:#111;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.small{padding:6px 10px;border-radius:8px;font-size:14px}
.table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;margin-top:10px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:var(--primary);color:#fff;position:sticky;top:0}
.item{background:#fbfdff;padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid #eef5ff}
.mini-row{display:flex;gap:8px;align-items:center}
.mini-row input{flex:1}
.mini-row button{flex:0 0 auto}
.mini-res{margin-top:8px}
.qty-badge{display:inline-block;padding:4px 8px;border-radius:999px;color:#fff;font-weight:600;font-size:13px}
.qty-red{background:var(--red)}
.qty-orange{background:var(--orange);color:#fff}
.qty-lightgreen{background:var(--lightgreen)}
.qty-green{background:var(--green)}
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.78);color:#fff;padding:10px 16px;border-radius:18px;display:none;z-index:2000}
.admin-btn{position:fixed;right:14px;bottom:18px;background:transparent;border:0;z-index:1500}
.admin-btn .gear{background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:10px}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:2000}
.modal .card{width:92%;max-width:420px}
.footer-note{color:#666;text-align:center;padding:18px 0;font-size:13px}
@media(max-width:600px){body{padding:92px 12px 20px} .nav-tabs button{padding:6px 8px;font-size:14px} th,td{padding:8px;font-size:13px}}
/* small: image cell style */
.img-cell { width:110px; padding:6px; }
.img-cell img { width:80px; height:56px; object-fit:cover; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.06); cursor:zoom-in; }
</style>
</head>
<body>
<div class="navbar" role="banner">
  <div class="brand">
    <h1>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
  </div>
  <div class="nav-tabs" role="tablist" aria-label="ä¸»å¯¼èˆª">
    <button class="tabbtn active" data-tab="tab-search"><span class="icon">ğŸ“Š</span><span>åº“å­˜æŸ¥è¯¢</span></button>
    <button class="tabbtn" data-tab="tab-chuhuo"><span class="icon">ğŸ“¦</span><span>å‡ºè´§è®¡åˆ’</span></button>
    <button class="tabbtn" data-tab="tab-haiyun"><span class="icon">ğŸš¢</span><span>æµ·è¿å…¥åº“</span></button>
  </div>
</div>

<div class="container">
  <!-- åº“å­˜æŸ¥è¯¢ -->
  <div id="tab-search" class="card tab" role="tabpanel">
    <h3>ğŸ“Š åº“å­˜æŸ¥è¯¢</h3>
    <div class="thai">(à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸à¸ªà¸´à¸™à¸„à¹‰à¸²)</div>
    <div class="label-small">ç“·ç –ç¼–å· (æ”¯æŒæ¨¡ç³Šæœç´¢)</div>
    <input id="searchCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯ï¼Œä¾‹å¦‚ AB123">
    <div class="controls">
      <button class="primary" id="searchBtn">æŸ¥è¯¢åº“å­˜<br><span class="thai">(à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸)</span></button>
      <button class="ghost" id="refreshBtn">åˆ·æ–°æ•°æ®<br><span class="thai">(à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥)</span></button>
    </div>
    <div id="lastInfo" style="margin-top:8px;color:#666;font-size:13px">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...</div>
    <div class="table-wrap">
      <table id="mainTable" style="display:none">
        <thead><tr><th>å›¾ç‰‡</th><th>ç¼–å·</th><th>è‰²å·</th><th>æ•°é‡(ç®±)</th><th>ä»“åº“</th></tr></thead>
        <tbody id="mainTbody"></tbody>
      </table>
      <div id="mainMsg" style="padding:12px;color:#888">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
    </div>
  </div>

  <!-- å‡ºè´§è®¡åˆ’ -->
  <div id="tab-chuhuo" class="card tab" style="display:none">
    <h3>ğŸ“¦ å‡ºè´§è®¡åˆ’</h3>
    <div class="thai">(à¹à¸œà¸™à¸à¸²à¸£à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²)</div>
    <label>æ—¥æœŸ</label><input id="ch_date" type="date">
    <label>å•ä½æˆ–è½¦ç‰Œ</label><input id="ch_vehicle" type="text">
    <label>å®¢æˆ·</label><input id="ch_customer" type="text">
    <div id="ch_items"></div>
    <div class="controls">
      <button class="primary" id="ch_add">+ æ·»åŠ è´§é¡¹<br><span class='thai'>(+ à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²)</span></button>
      <button class="ghost" id="ch_gen">ç”Ÿæˆæ–‡å­—<br><span class='thai'>(à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)</span></button>
      <button class="primary" id="ch_copy">å¤åˆ¶<br><span class='thai'>(à¸„à¸±à¸”à¸¥à¸­à¸)</span></button>
    </div>
    <pre id="ch_result" style="margin-top:10px">ï¼ˆè¯·å…ˆå¡«å†™è¡¨å•ï¼‰</pre>
  </div>

  <!-- æµ·è¿å…¥åº“ -->
  <div id="tab-haiyun" class="card tab" style="display:none">
    <h3>ğŸš¢ æµ·è¿å…¥åº“</h3>
    <div class="thai">(à¸™à¸³à¹€à¸‚à¹‰à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸²à¸‡à¹€à¸£à¸·à¸­)</div>
    <label>æ—¥æœŸ</label><input id="hy_date" type="date">
    <label>æŸœå·</label><input id="hy_container" type="text">
    <label>å…¥åº“ä»“åº“ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰</label><input id="hy_warehouse" placeholder="ä¾‹å¦‚ï¼šK38ä»“åº“">
    <div id="hy_items"></div>
    <div class="controls">
      <button class="primary" id="hy_add">+ æ·»åŠ è´§é¡¹<br><span class='thai'>(+ à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²)</span></button>
      <button class="ghost" id="hy_gen">ç”Ÿæˆæ–‡å­—<br><span class='thai'>(à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)</span></button>
      <button class="primary" id="hy_copy">å¤åˆ¶<br><span class='thai'>(à¸„à¸±à¸”à¸¥à¸­à¸)</span></button>
    </div>
    <pre id="hy_result" style="margin-top:10px">ï¼ˆè¯·å…ˆå¡«å†™è¡¨å•ï¼‰</pre>
  </div>

  <!-- ç®¡ç†å‘˜åŒºåŸŸï¼ˆåº•éƒ¨å°æŒ‰é’®è§¦å‘ï¼‰ -->
  <div id="admin_placeholder" style="height:18px"></div>

  <div class="footer-note">ä»…é™å†…éƒ¨ä½¿ç”¨ | Designed by Kyson Li</div>
</div>

<!-- ç®¡ç†å‘˜æŒ‰é’® -->
<button class="admin-btn" id="adminToggle" title="ç®¡ç†å‘˜ç™»å½•">
  <span class="gear">âš™ï¸ ç®¡ç†å‘˜ç™»å½•</span>
</button>

<!-- ç®¡ç†å‘˜å¼¹çª— -->
<div class="modal" id="adminModal" role="dialog" aria-modal="true">
  <div class="card">
    <h3>ğŸ” ç®¡ç†å‘˜åŠŸèƒ½</h3>
    <div class="thai">(à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š)</div>
    <label>ç®¡ç†å‘˜å¯†ç </label>
    <input id="adminPw" type="password" placeholder="è¾“å…¥å¯†ç ">
    <div class="controls" style="margin-top:8px">
      <button class="primary" id="adminLogin">ç™»å½•<br><span class='thai'>(à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š)</span></button>
      <button class="ghost" id="adminClose">å–æ¶ˆ</button>
    </div>
    <div id="adminArea" style="display:none;margin-top:12px">
      <div class="label-small">ä¸Šä¼  Excel æ–‡ä»¶ï¼ˆBåˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ŒJåˆ—=æ•°é‡ï¼‰</div>
      <input id="excelInput" type="file" accept=".xlsx,.xls">
      <div class="controls" style="margin-top:8px">
        <button class="secondary" id="btnSave">ä¿å­˜å¹¶å†™å…¥ Firebase<br><span class='thai'>(à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥)</span></button>
        <button class="ghost" id="btnPreview">é¢„è§ˆæ•°æ®</button>
      </div>
      <div id="previewBox" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // Tabs
  const tabButtons = document.querySelectorAll('.tabbtn');
  tabButtons.forEach(b=>{
    b.addEventListener('click', ()=> {
      tabButtons.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
      const id = 'tab-' + b.dataset.tab?.split?.('-')?.pop?.() || b.dataset.tab;
      // mapping: use dataset tab value directly (we set data-tab to tab-search etc.)
      const target = b.dataset.tab;
      document.getElementById(target).style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2400); }

  // Stock data
  let stockData = [];
  async function loadStockData(){
    if(!window.firebase){ showToast('Firebase æœªåˆå§‹åŒ–'); return; }
    try{
      const snap = await window.firebase.get(window.firebase.stockRef);
      const val = snap.val();
      if(val && val.stockData){ stockData = val.stockData; document.getElementById('lastInfo').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š' + (val.updateTime || new Date().toLocaleString()); showToast('å·²åŠ è½½åº“å­˜æ•°æ®'); }
      else { stockData = []; showToast('æš‚æ— åº“å­˜æ•°æ®'); }
    }catch(e){ console.error(e); showToast('åŠ è½½åº“å­˜å¤±è´¥'); }
  }

  // render quantity with color
  function qtyBadge(num){
    const n = Number(num) || 0;
    if(n <= 50) return `<span class="qty-badge qty-red">${n}</span>`;
    if(n <= 200) return `<span class="qty-badge qty-orange">${n}</span>`;
    if(n <= 500) return `<span class="qty-badge qty-lightgreen">${n}</span>`;
    return `<span class="qty-badge qty-green">${n}</span>`;
  }

  /* ------------------ æ–°å¢ï¼šå›¾ç‰‡é™„åŠ å…¼å®¹å‡½æ•°ï¼ˆä¸ç ´ååŸé€»è¾‘ï¼‰ ------------------ */
  // ä¼˜å…ˆä½¿ç”¨æ³¨å…¥çš„éä¾µå…¥æ¨¡å—ï¼›è‹¥æœªå°±ç»ªï¼Œåˆ™ç›´æ¥ä» GitHub raw åŠ è½½
  const NS_GITHUB_BASE = "https://raw.githubusercontent.com/li995913596-beep/tile-images/main/";
  function nsAttachImg(td, code){
    if(!td) return;
    // if image already present, skip
    if(td.querySelector('img')) return;
    // If the non-invasive module is available, use it
    try{
      if(window.nsTileImages && typeof window.nsTileImages.attachImgToCell === 'function'){
        // that function expects (td, identifier)
        window.nsTileImages.attachImgToCell(td, code);
        return;
      }
    }catch(e){}
    // fallback simple implementation
    const img = document.createElement('img');
    img.alt = code || 'tile';
    img.style.width='80px';
    img.style.height='56px';
    img.style.objectFit='cover';
    img.style.borderRadius='6px';
    img.style.cursor='zoom-in';
    img.src = NS_GITHUB_BASE + encodeURIComponent(String(code)) + '.jpg';
    img.onerror = function(){
      this.onerror = null;
      this.src = NS_GITHUB_BASE + encodeURIComponent(String(code)) + '.jpeg';
      this.onerror = function(){ this.onerror=null; this.src = NS_GITHUB_BASE + encodeURIComponent(String(code)) + '.png'; }
    };
    img.addEventListener('click', function(e){
      e.stopPropagation();
      // show simple modal
      let modal = document.getElementById('nsTileImageModal');
      if(modal){
        const mimg = document.getElementById('nsTileImageModalImg');
        mimg.src = img.src;
        modal.classList.add('show');
      } else {
        // create temporary modal
        let m = document.createElement('div');
        m.style.position='fixed'; m.style.inset='0'; m.style.background='rgba(0,0,0,0.6)'; m.style.display='flex';
        m.style.alignItems='center'; m.style.justifyContent='center'; m.style.zIndex='99999';
        let im = document.createElement('img'); im.src = img.src; im.style.maxWidth='90%'; im.style.maxHeight='90%'; im.style.borderRadius='8px';
        m.appendChild(im);
        m.addEventListener('click', ()=>document.body.removeChild(m));
        document.body.appendChild(m);
      }
    });
    td.appendChild(img);
  }
  /* ------------------ end æ–°å¢ ------------------ */

  // main search
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const key = document.getElementById('searchCode').value.trim().toLowerCase();
    const table = document.getElementById('mainTable'), tbody = document.getElementById('mainTbody'), msg = document.getElementById('mainMsg');
    tbody.innerHTML=''; table.style.display='none'; msg.textContent='';
    if(!key){ msg.textContent='è¯·è¾“å…¥ç¼–å·å…³é”®è¯'; return; }
    const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(key));
    if(!res.length){ msg.textContent='æœªæ‰¾åˆ°ç»“æœ'; return; }
    res.forEach(r=>{
      const tr = document.createElement('tr');
      // Insert image cell as the first column, then original columns (preserve original order logically)
      tr.innerHTML = `<td class="img-cell"></td><td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td>`;
      tbody.appendChild(tr);
      // Attach image into the image cell (non-destructive)
      try { nsAttachImg(tr.querySelector('.img-cell'), r.code); } catch(e){ console.error('nsAttachImg error',e); }
    });
    table.style.display='table';
  });
  document.getElementById('refreshBtn').addEventListener('click', loadStockData);

  // å‡ºè´§è®¡åˆ’: add item with aligned search button
  const chList = document.getElementById('ch_items');
  function addChItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <div class="mini-row">
        <div style="flex:1">
          <label>á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·</label>
          <input class="ch-code" placeholder="è¾“å…¥ç¼–å·">
        </div>
        <button class="small ch-search">æŸ¥è¯¢åº“å­˜</button>
      </div>
      <div class="mini-res"></div>
      <label>á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·</label><input class="ch-color">
      <label>á€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼</label><input class="ch-spec">
      <label>á€¡á€›á€±á€¡á€á€½á€€á€º/æ•°é‡</label><input class="ch-qty">`;
    chList.appendChild(el);
    if(v.code) el.querySelector('.ch-code').value = v.code;
    if(v.color) el.querySelector('.ch-color').value = v.color;
    if(v.spec) el.querySelector('.ch-spec').value = v.spec;
    if(v.qty) el.querySelector('.ch-qty').value = v.qty;

    const btn = el.querySelector('.ch-search');
    const codeInput = el.querySelector('.ch-code');
    const resDiv = el.querySelector('.mini-res');

    btn.addEventListener('click', ()=>{
      const q = codeInput.value.trim().toLowerCase();
      resDiv.innerHTML = '<div style="color:#666;padding:6px">æŸ¥è¯¢ä¸­...</div>';
      if(!q){ resDiv.innerHTML = '<div style="color:#c00;padding:6px">è¯·è¾“å…¥ç¼–å·</div>'; return; }
      const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(q));
      if(!res.length){ resDiv.innerHTML = '<div style="color:#666;padding:6px">æœªæ‰¾åˆ°åº“å­˜ä¿¡æ¯</div>'; return; }
      let html = '<div class="table-wrap"><table><thead><tr><th>ç¼–å·</th><th>è‰²å·</th><th>æ•°é‡(ç®±)</th><th>ä»“åº“</th></tr></thead><tbody>';
      res.forEach(r => html += `<tr><td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td></tr>`);
      html += '</tbody></table></div>';
      resDiv.innerHTML = html;
    });
  }
  addChItem();
  document.getElementById('ch_add').addEventListener('click', ()=>addChItem());
  document.getElementById('ch_gen').addEventListener('click', ()=>{
    const date = document.getElementById('ch_date').value;
    const vehicle = document.getElementById('ch_vehicle').value;
    const customer = document.getElementById('ch_customer').value;
    let text = `å‡ºè´§è®¡åˆ’\næ—¥æœŸï¼š${date}\nå•ä½æˆ–è½¦ç‰Œï¼š${vehicle}\nå®¢æˆ·ï¼š${customer}\n\n`;
    Array.from(chList.children).forEach((el,idx)=>{
      const code = el.querySelector('.ch-code').value;
      const color = el.querySelector('.ch-color').value;
      const spec = el.querySelector('.ch-spec').value;
      const qty = el.querySelector('.ch-qty').value;
      text += `${idx+1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${code}\ná€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${color}\ná€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${spec}\ná€¡á€›á€±á€¡à¸±à¸à¸—à¹Œ/æ•°é‡ï¼š${qty}\n\n`;
    });
    document.getElementById('ch_result').textContent = text.trim();
    showToast('å·²ç”Ÿæˆå‡ºè´§è®¡åˆ’');
  });
  document.getElementById('ch_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('ch_result').textContent); showToast('å·²å¤åˆ¶'); });

  // æµ·è¿å…¥åº“
  const hyList = document.getElementById('hy_items');
  function addHyItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <label>á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·</label><input class="hy-code">
      <label>è§„æ ¼/á€¡á€œá€»á€¬á€¸á€¡á€”á€¶</label><input class="hy-spec">
      <label>è‰²å·/á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€º</label><input class="hy-color">
      <label>æ•°é‡/á€¡á€›á€±á€¡Å‚oÅ›Ä‡</label><input class="hy-qty">`;
    hyList.appendChild(el);
    if(v.code) el.querySelector('.hy-code').value = v.code;
    if(v.spec) el.querySelector('.hy-spec').value = v.spec;
    if(v.color) el.querySelector('.hy-color').value = v.color;
    if(v.qty) el.querySelector('.hy-qty').value = v.qty;
  }
  addHyItem();
  document.getElementById('hy_add').addEventListener('click', ()=>addHyItem());
  document.getElementById('hy_gen').addEventListener('click', ()=>{
    const date = document.getElementById('hy_date').value;
    const container = document.getElementById('hy_container').value;
    const warehouse = document.getElementById('hy_warehouse').value || '';
    let text = `æµ·è¿å…¥åº“ï¼š${warehouse}\næ—¥æœŸï¼š${date}\næŸœå·ï¼š${container}\n\n`;
    Array.from(hyList.children).forEach((el,idx)=>{
      const code = el.querySelector('.hy-code').value;
      const spec = el.querySelector('.hy-spec').value;
      const color = el.querySelector('.hy-color').value;
      const qty = el.querySelector('.hy-qty').value;
      text += `${idx+1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${code}\ná€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${spec}\ná€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${color}\ná€¡á€›á€±á€¡à¸²à¸ªà¸•à¸£à¹Œ/æ•°é‡ï¼š${qty}\n\n`;
    });
    document.getElementById('hy_result').textContent = text.trim();
    showToast('å·²ç”Ÿæˆæµ·è¿å…¥åº“');
  });
  document.getElementById('hy_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('hy_result').textContent); showToast('å·²å¤åˆ¶'); });

  // Admin modal behavior
  const adminToggle = document.getElementById('adminToggle');
  const adminModal = document.getElementById('adminModal');
  const adminClose = document.getElementById('adminClose');
  adminToggle.addEventListener('click', ()=>{ adminModal.style.display = 'flex'; });
  adminClose.addEventListener('click', ()=>{ adminModal.style.display = 'none'; });
  adminModal.addEventListener('click', (e)=>{ if(e.target === adminModal) adminModal.style.display='none'; });

  document.getElementById('adminLogin').addEventListener('click', ()=>{
    const pw = document.getElementById('adminPw').value.trim();
    if(pw === 'admin'){ document.getElementById('adminArea').style.display='block'; showToast('ç®¡ç†å‘˜å·²ç™»å½•'); }
    else showToast('å¯†ç é”™è¯¯');
  });

  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('è¯·é€‰æ‹© Excel æ–‡ä»¶'); return; }
    const reader = new FileReader();
    reader.onload = (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      document.getElementById('previewBox').innerHTML = '<pre style="max-height:280px;overflow:auto">'+JSON.stringify(items.slice(0,200),null,2)+'</pre>';
      showToast('é¢„è§ˆå·²ç”Ÿæˆ');
    };
    reader.readAsArrayBuffer(f);
  });

  document.getElementById('btnSave').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('è¯·é€‰æ‹© Excel æ–‡ä»¶'); return; }
    const reader = new FileReader();
    reader.onload = async (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      if(!window.firebase){ showToast('Firebase æœªå°±ç»ª'); return; }
      try{
        const updateTime = new Date().toLocaleString();
        await window.firebase.set(window.firebase.stockRef, { stockData: items, updateTime });
        showToast('å·²ä¿å­˜åˆ° Firebase');
        stockData = items;
        document.getElementById('lastInfo').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š' + updateTime;
        adminModal.style.display='none';
      }catch(err){ console.error(err); showToast('ä¿å­˜å¤±è´¥'); }
    };
    reader.readAsArrayBuffer(f);
  });

  // initial load
  setTimeout(()=>{ if(window.firebaseInitialized) loadStockData(); }, 600);

  // allow enter key for search
  document.getElementById('searchCode').addEventListener('keypress', (e)=>{ if(e.key==='Enter') document.getElementById('searchBtn').click(); });

})();
</script>

<!-- BEGIN NON-INVASIVE TILE IMAGE FEATURE (ADDED) -->
<style>
/* Non-invasive thumbnail styles, namespaced to avoid collisions */
.ns-tile-thumb { width:80px; height:56px; object-fit:cover; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.06); cursor:zoom-in; }
.ns-tile-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:99999; padding:20px; }
.ns-tile-modal.show { display:flex; } .ns-tile-modal img { max-width:96%; max-height:96%; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
.ns-image-loader-btn { margin-left:8px; padding:6px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; font-size:13px; }
.ns-image-insert-note { font-size:12px; color:#666; margin-left:8px; }
</style>

<!-- Modal -->
<div id="nsTileImageModal" class="ns-tile-modal" onclick="document.getElementById('nsTileImageModal').classList.remove('show')">
  <img id="nsTileImageModalImg" src="" alt="Tile preview">
</div>

<script>
(function(){
  // Configuration: prefilled base from your GitHub (keeps original unchanged)
  const GITHUB_RAW_BASE_NS = "https://raw.githubusercontent.com/li995913596-beep/tile-images/main/"; // already configured

  const PLACEHOLDER = "data:image/svg+xml;utf8," + encodeURIComponent(
    '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"300\" height=\"200\">' +
    '<rect width=\"100%\" height=\"100%\" fill=\"#f7f7f7\"/>' +
    '<text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#bbb\" font-size=\"16\">No image</text>' +
    '</svg>'
  );

  function makeCandidates(id){
    if(!id) return [];
    const clean = String(id).trim();
    return [
      GITHUB_RAW_BASE_NS + encodeURIComponent(clean) + ".jpg",
      GITHUB_RAW_BASE_NS + encodeURIComponent(clean) + ".jpeg",
      GITHUB_RAW_BASE_NS + encodeURIComponent(clean) + ".png"
    ];
  }

  function attachImgToCell(td, identifier){
    if(!td) return;
    // if already has our img, skip
    if(td.querySelector('.ns-tile-thumb')) return;
    const img = document.createElement('img');
    img.className = 'ns-tile-thumb';
    img.loading = 'lazy';
    img.alt = identifier || 'tile';
    img.style.background = '#fff';
    img.addEventListener('click', function(e){
      e.stopPropagation();
      const modal = document.getElementById('nsTileImageModal');
      const modalImg = document.getElementById('nsTileImageModalImg');
      modalImg.src = img.dataset.fullsrc || img.src || PLACEHOLDER;
      modal.classList.add('show');
    });
    td.appendChild(img);

    const candidates = makeCandidates(identifier);
    if(candidates.length === 0){ img.src = PLACEHOLDER; return; }
    let i=0;
    function tryNext(){
      if(i>=candidates.length){ img.src = PLACEHOLDER; return; }
      const url = candidates[i++];
      img.crossOrigin = "anonymous";
      img.onload = function(){ img.dataset.fullsrc = url; };
      img.onerror = function(){ tryNext(); };
      img.src = url;
    }
    tryNext();
  }

  // Heuristic to detect a "code" in cell text: letters/numbers and at least one digit, length 2-30
  function looksLikeCode(text){
    if(!text) return false;
    text = text.trim();
    if(text.length < 2 || text.length > 40) return false;
    // must contain a letter or digit, and at least one digit
    if(!/[0-9]/.test(text)) return false;
    // avoid purely numeric long numbers (allow though), accept letters/digits/-_
    return /^[\u0020-\u007E\u4E00-\u9FFF][\w\-\s\u4E00-\u9FFF]*$/.test(text);
  }

  // Auto-scan table rows and insert thumbnail td at start
  function autoAttachThumbnails(){
    // Find table rows or list items
    const tables = Array.from(document.querySelectorAll('table'));
    let attached = 0;
    if(tables.length){
      tables.forEach(table=>{
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        if(rows.length === 0){
          // try all tr
          rows.push(...Array.from(table.querySelectorAll('tr')));
        }
        rows.forEach(tr=>{
          try{
            // skip if we've already inserted
            if(tr.querySelector('.ns-tile-thumb')) return;
            const tds = Array.from(tr.children).filter(n=>n.tagName.toLowerCase()==='td' || n.tagName.toLowerCase()==='th');
            // find first td that looks like code
            let codeCellIndex = -1;
            for(let i=0;i<tds.length;i++){
              const txt = tds[i].textContent || '';
              if(looksLikeCode(txt) && txt.trim().length <= 40){
                codeCellIndex = i;
                break;
              }
            }
            if(codeCellIndex === -1) return;
            const codeText = (tds[codeCellIndex].textContent||'').trim().split(/\s+/)[0];
            // insert a new td at beginning for thumbnail
            const imgTd = document.createElement('td');
            imgTd.style.padding = '6px';
            // For tables with fixed columns, try not to break layout: if first child is th, insert after it
            tr.insertBefore(imgTd, tr.firstChild);
            attachImgToCell(imgTd, codeText);
            attached++;
          }catch(e){ /* ignore */ }
        });
      });
    }
    // Also try list-like rows (divs)
    const rows = Array.from(document.querySelectorAll('div'));
    rows.forEach(div=>{
      try{
        if(div.querySelector('.ns-tile-thumb')) return;
        // if this div likely a result card containing code text
        const txt = (div.textContent||'').trim();
        if(looksLikeCode(txt) && txt.length < 200 && txt.split(/\s+/).length <= 6){
          // create img and prepend
          const imgWrap = document.createElement('div');
          imgWrap.style.display = 'inline-block';
          imgWrap.style.marginRight = '8px';
          attachImgToCell(imgWrap, txt.split(/\s+/)[0]);
          div.insertBefore(imgWrap, div.firstChild);
          attached++;
        }
      }catch(e){}
    });
    return attached;
  }

  // Manual mode: user clicks one cell to indicate code column
  function enableManualColumnSelect(){
    alert('è¯·ç‚¹å‡»ä»»ä¸€æœç´¢ç»“æœä¸­æ˜¾ç¤ºâ€œç¼–å·â€çš„å•å…ƒæ ¼ï¼ˆç‚¹å‡»åä¼šè‡ªåŠ¨ä¸ºæ•´åˆ—æ·»åŠ å›¾ç‰‡ï¼‰ï¼ŒæŒ‰ Esc å–æ¶ˆã€‚');
    function clickHandler(e){
      e.preventDefault(); e.stopPropagation();
      const target = e.target;
      // find nearest tr
      const tr = target.closest('tr');
      if(!tr){
        document.removeEventListener('click', clickHandler, true);
        return;
      }
      // determine index of clicked cell among its siblings
      const cells = Array.from(tr.children).filter(n=>n.tagName.toLowerCase()==='td' || n.tagName.toLowerCase()==='th');
      let idx = -1;
      for(let i=0;i<cells.length;i++){
        if(cells[i] === target || cells[i].contains(target)){
          idx = i; break;
        }
      }
      if(idx === -1){
        document.removeEventListener('click', clickHandler, true);
        return;
      }
      // For each row in same table, get cell at idx and insert thumbnail cell before that row's first child
      const table = tr.closest('table');
      if(!table){ document.removeEventListener('click', clickHandler, true); return; }
      const allRows = Array.from(table.querySelectorAll('tr'));
      let count = 0;
      allRows.forEach(r=>{
        const cellsR = Array.from(r.children).filter(n=>n.tagName.toLowerCase()==='td' || n.tagName.toLowerCase()==='th');
        if(cellsR.length > idx){
          const codeText = (cellsR[idx].textContent||'').trim().split(/\s+/)[0];
          const imgTd = document.createElement('td');
          imgTd.style.padding = '6px';
          r.insertBefore(imgTd, r.firstChild);
          attachImgToCell(imgTd, codeText);
          count++;
        }
      });
      document.removeEventListener('click', clickHandler, true);
      alert('å·²ä¸ºè¡¨æ ¼ä¸­çš„ ' + count + ' è¡Œå°è¯•æ·»åŠ å›¾ç‰‡åˆ—ï¼ˆå¦‚å¯ç”¨ï¼‰ã€‚');
    }
    document.addEventListener('click', clickHandler, true);
    // Esc cancels
    function escHandler(e){ if(e.key === 'Escape'){ document.removeEventListener('click', clickHandler, true); document.removeEventListener('keydown', escHandler, true); alert('å·²å–æ¶ˆ'); } }
    document.addEventListener('keydown', escHandler, true);
  }

  // Insert UI buttons non-invasively into first .topbar or body start
  function insertControlButtons(){
    const container = document.querySelector('.topbar') || document.body;
    if(!container) return;
    // prevent duplicate
    if(document.getElementById('nsLoadImagesBtn')) return;
    const btnAuto = document.createElement('button');
    btnAuto.id = 'nsLoadImagesBtn';
    btnAuto.className = 'ns-image-loader-btn';
    btnAuto.textContent = 'åŠ è½½å›¾ç‰‡ï¼ˆè‡ªåŠ¨ï¼‰';
    btnAuto.title = 'å°è¯•è‡ªåŠ¨åœ¨è¡¨æ ¼/åˆ—è¡¨ä¸­æ‰¾åˆ°ç¼–å·å¹¶é™„ä¸Šå›¾ç‰‡ï¼ˆä¸ä¼šæ”¹å˜åŸé€»è¾‘ï¼‰';
    btnAuto.addEventListener('click', function(){ const added = autoAttachThumbnails(); alert('å·²å°è¯•ä¸ºé¡µé¢æ·»åŠ  ' + added + ' ä¸ªç¼©ç•¥å›¾ï¼ˆå¦‚å¯ç”¨ï¼‰ã€‚'); });

    const btnManual = document.createElement('button');
    btnManual.id = 'nsLoadImagesManualBtn';
    btnManual.className = 'ns-image-loader-btn';
    btnManual.textContent = 'åŠ è½½å›¾ç‰‡ï¼ˆæ‰‹åŠ¨åˆ—ï¼‰';
    btnManual.title = 'æ‰‹åŠ¨é€‰æ‹©æ˜¾ç¤ºç¼–å·çš„åˆ—ï¼ˆç‚¹å‡»æŸä¸ªç¼–å·å•å…ƒæ ¼ï¼‰';
    btnManual.addEventListener('click', function(){ enableManualColumnSelect(); });

    const note = document.createElement('span');
    note.className = 'ns-image-insert-note';
    note.textContent = 'ï¼ˆå›¾ç‰‡æŒ‰ç¼–å·åŒ¹é…ï¼Œç¼–å·ç›¸åŒæ—¶æ˜¾ç¤ºåŒä¸€å¼ å›¾ç‰‡ï¼‰';

    // append
    container.appendChild(btnAuto);
    container.appendChild(btnManual);
    container.appendChild(note);
  }

  // run on DOMContentLoaded
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', insertControlButtons);
  } else {
    insertControlButtons();
  }

  // expose functions for advanced use (non-enumerable)
  Object.defineProperty(window, 'nsTileImages', { value: { autoAttachThumbnails, enableManualColumnSelect, attachImgToCell }, writable:false, configurable:true });
})();
</script>
<!-- END NON-INVASIVE TILE IMAGE FEATURE -->

</body>
</html>
