<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>库存搜索（带图片预览）</title>

  <!-- ========== 样式 ========== -->
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 12px; background:#f6f7fb; color:#222; }
    h1 { font-size:18px; margin-bottom:8px; }

    .topbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    input[type="search"] { padding:8px 10px; font-size:14px; border-radius:8px; border:1px solid #ddd; width:100%; max-width:480px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #bbb; background:#fff; cursor:pointer; }

    .search-results-wrapper { margin-top:12px; }

    /* 表格样式（桌面） */
    .search-results-table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow: 0 6px 20px rgba(18,20,30,0.04);
    }
    .search-results-table th, .search-results-table td {
      padding:10px 12px;
      border-bottom:1px solid #f0f0f0;
      font-size:13px;
      text-align:left;
      vertical-align:middle;
    }
    .search-results-table thead th { background:#fbfbfd; font-weight:600; font-size:13px; }

    .tile-thumb {
      width:96px;
      height:64px;
      object-fit:cover;
      border-radius:6px;
      box-shadow:0 1px 6px rgba(0,0,0,0.06);
      cursor:zoom-in;
    }

    /* 卡片式（移动） */
    @media (max-width:720px) {
      .search-results-table, .search-results-table thead, .search-results-table tbody, .search-results-table th, .search-results-table td, .search-results-table tr {
        display:block;
      }
      .search-results-table thead { display:none; }
      .result-card {
        display:flex;
        gap:10px;
        padding:10px;
        margin-bottom:10px;
        border-radius:8px;
        background:#fff;
        box-shadow:0 6px 18px rgba(10,12,20,0.04);
        align-items:center;
      }
      .card-info { flex:1; font-size:14px; }
      .card-info div { margin-bottom:4px; }
      .tile-thumb { width:84px; height:60px; }
    }

    /* 放大 modal */
    .tile-modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); z-index:9999; padding:20px;
    }
    .tile-modal.show { display:flex; }
    .tile-modal img { max-width:96%; max-height:96%; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }

    .muted { color:#777; font-size:13px; }
    .small { font-size:12px; color:#666; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #resultsInfo { margin-top:8px; font-size:13px; color:#444; }
    .file-input { display:inline-block; }
  </style>
</head>
<body>

  <h1>库存搜索（带图片预览）</h1>

  <div class="topbar">
    <input id="searchInput" type="search" placeholder="输入编号或色号搜索（回车或点击搜索）" />
    <button id="searchBtn">搜索</button>
    <button id="showAllBtn">显示全部（示例数据）</button>
    <!-- 可选：上传 CSV 做本地测试 -->
    <label class="file-input small">
      <input id="fileInput" type="file" accept=".csv,.xlsx" style="display:none" />
      <button id="uploadBtn" title="上传 CSV 做本地测试">导入 CSV</button>
    </label>
  </div>

  <div id="resultsInfo" class="muted">暂无查询，或点击“显示全部”查看示例数据。</div>

  <div class="search-results-wrapper">
    <div id="searchResults"></div>
  </div>

  <!-- 放大图片 Modal（一次） -->
  <div id="tileImageModal" class="tile-modal" onclick="document.getElementById('tileImageModal').classList.remove('show')">
    <img id="tileImageModalImg" src="" alt="Tile preview">
  </div>

  <!-- ========== 脚本 ========== -->
  <script>
  /**************************************************************************
   * 完整页面 JS —— 搜索结果 + 缩略图 + 点击放大
   * 用法：
   *   - 把你的真实库存数据替换 sampleStock 数组（同结构）
   *   - 或在你的原有代码里调用 renderStockSearchResults(stockItems, '#searchResults')
   *
   * 重要配置项：
   *   - GITHUB_RAW_BASE: 改成你的 raw.githubusercontent.com 的基础路径（以 / 结尾）
   *
   **************************************************************************/

  // ---------- 配置：把下面改成你的 GitHub raw 基础路径 ----------
  // 示例: "https://raw.githubusercontent.com/YOURNAME/REPO/main/images/"
  const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/yourname/yourrepo/main/images/"; // <-- 请替换

  // 占位图（SVG data URL）
  const PLACEHOLDER_DATAURL = "data:image/svg+xml;utf8," + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200">' +
    '<rect width="100%" height="100%" fill="#f7f7f7"/>' +
    '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#bbb" font-size="16">No image</text>' +
    '</svg>'
  );

  // ---------- 示例库存数据（替换点） ----------
  // 你可以把这里替换成你生产环境的 stockData（来自 Firebase / 后端 / Excel 解析等）
  // 每项对象需要包含 { code, color, warehouse, quantity }
  const sampleStock = [
    { code: "A100-01", color: "白玉", warehouse: "K39", quantity: 120 },
    { code: "B200-02", color: "灰岩", warehouse: "K41", quantity: 48 },
    { code: "C300-03", color: "米黄", warehouse: "K39", quantity: 260 },
    { code: "D400-01", color: "深蓝", warehouse: "K42", quantity: 12 }
  ];

  // ---------- 生成图片候选 URL（按后缀尝试） ----------
  function makeTileImageCandidates(identifier) {
    if (!identifier) return [];
    const id = String(identifier).trim();
    // 尝试以 code 为文件名；你也可以改成 color 或其他规则
    return [
      GITHUB_RAW_BASE + encodeURIComponent(id) + ".jpg",
      GITHUB_RAW_BASE + encodeURIComponent(id) + ".jpeg",
      GITHUB_RAW_BASE + encodeURIComponent(id) + ".png"
    ];
  }

  // ---------- 将缩略图附加到容器（幂等） ----------
  function attachTileThumbnail(containerEl, identifier) {
    let img = containerEl.querySelector('.tile-thumb');
    if (!img) {
      img = document.createElement('img');
      img.className = 'tile-thumb';
      img.alt = 'Tile';
      img.loading = 'lazy';
      img.style.background = '#fff';
      img.addEventListener('click', function(e){
        e.stopPropagation();
        const modal = document.getElementById('tileImageModal');
        const modalImg = document.getElementById('tileImageModalImg');
        modalImg.src = img.dataset.fullsrc || img.src || PLACEHOLDER_DATAURL;
        modal.classList.add('show');
      });
      containerEl.appendChild(img);
    }

    const candidates = makeTileImageCandidates(identifier);
    if (candidates.length === 0) {
      img.src = PLACEHOLDER_DATAURL;
      return;
    }

    let i = 0;
    function tryNext() {
      if (i >= candidates.length) {
        img.src = PLACEHOLDER_DATAURL;
        return;
      }
      const url = candidates[i++];
      img.crossOrigin = "anonymous";
      img.onload = function(){
        img.dataset.fullsrc = url;
      };
      img.onerror = function(){
        tryNext();
      };
      img.src = url;
    }
    tryNext();
  }

  // ---------- 渲染函数：把 stockItems 渲染到目标容器 ----------
  function renderStockSearchResults(stockItems, targetSelector) {
    const parent = (typeof targetSelector === 'string') ? document.querySelector(targetSelector) : targetSelector;
    if (!parent) {
      console.warn('renderStockSearchResults: target container not found:', targetSelector);
      return;
    }
    parent.innerHTML = '';

    // 简单信息
    const info = document.getElementById('resultsInfo');
    info.textContent = `共 ${stockItems.length} 条结果（展示最新 500 条或全部）；点击缩略图可放大查看。`;

    // 表格（桌面），以及同时生成移动卡片（由 CSS 控制显示）
    const table = document.createElement('table');
    table.className = 'search-results-table';
    table.innerHTML = `<thead><tr>
      <th>图片</th><th>编号</th><th>色号</th><th>仓库</th><th>数量</th>
    </tr></thead>`;
    const tbody = document.createElement('tbody');

    stockItems.forEach(item => {
      const tr = document.createElement('tr');
      const tdImg = document.createElement('td'); tdImg.style.width = '110px'; tr.appendChild(tdImg);

      const tdCode = document.createElement('td'); tdCode.textContent = item.code||''; tr.appendChild(tdCode);
      const tdColor = document.createElement('td'); tdColor.textContent = item.color||''; tr.appendChild(tdColor);
      const tdWarehouse = document.createElement('td'); tdWarehouse.textContent = item.warehouse||''; tr.appendChild(tdWarehouse);
      const tdQty = document.createElement('td'); tdQty.textContent = (item.quantity!=null?String(item.quantity):''); tr.appendChild(tdQty);

      attachTileThumbnail(tdImg, item.code || item.color);
      tbody.appendChild(tr);

      // 同时创建移动卡片（在窄屏时显示）
      const card = document.createElement('div');
      card.className = 'result-card';
      const imgWrap = document.createElement('div');
      attachTileThumbnail(imgWrap, item.code || item.color);
      const infoDiv = document.createElement('div');
      infoDiv.className = 'card-info';
      infoDiv.innerHTML = `<div><strong>${escapeHtml(item.code||'')}</strong></div>
                           <div>色号: ${escapeHtml(item.color||'')}</div>
                           <div>仓库: ${escapeHtml(item.warehouse||'')}</div>
                           <div>数量: ${escapeHtml(String(item.quantity||''))}</div>`;
      card.appendChild(imgWrap);
      card.appendChild(infoDiv);
      parent.appendChild(card);
    });

    table.appendChild(tbody);
    parent.appendChild(table);
  }

  // ---------- 简单搜索（按 code 或 color 包含匹配），有防抖 ----------
  function debounce(fn, wait=220){
    let t;
    return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
  }

  function doSearch(q) {
    const key = (q||'').trim().toLowerCase();
    // dataSource：如果你在生产环境使用实际数据，请把下面改成你的 stockData 变量
    const dataSource = window.stockData || sampleStock;
    if (!key) {
      document.getElementById('resultsInfo').textContent = '请输入关键字后搜索，或点击“显示全部”。';
      document.getElementById('searchResults').innerHTML = '';
      return;
    }
    const results = dataSource.filter(it => {
      return String(it.code||'').toLowerCase().includes(key) ||
             String(it.color||'').toLowerCase().includes(key) ||
             String(it.warehouse||'').toLowerCase().includes(key);
    });
    renderStockSearchResults(results, '#searchResults');
  }

  // ---------- 辅助：XSS 转义 ----------
  function escapeHtml(s) {
    return String(s||'').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  // ---------- 事件绑定 ----------
  document.getElementById('searchBtn').addEventListener('click', function(){
    const q = document.getElementById('searchInput').value;
    doSearch(q);
  });
  document.getElementById('searchInput').addEventListener('keydown', function(e){
    if (e.key === 'Enter') { doSearch(this.value); }
  });

  // 防抖即时搜索（可选）
  document.getElementById('searchInput').addEventListener('input', debounce(function(e){
    const v = e.target.value;
    if (v.length === 0) {
      document.getElementById('resultsInfo').textContent = '请输入关键字后搜索，或点击“显示全部”。';
      document.getElementById('searchResults').innerHTML = '';
      return;
    }
    // 若你希望输入即搜索，取消注释下一行：
    // doSearch(v);
  }, 300));

  // 显示全部（示例数据 / 或替换成实际 stockData）
  document.getElementById('showAllBtn').addEventListener('click', function(){
    const dataSource = window.stockData || sampleStock;
    renderStockSearchResults(dataSource, '#searchResults');
    document.getElementById('resultsInfo').textContent = `显示全部 ${dataSource.length} 条（示例/测试数据）。`;
  });

  // 导入 CSV（极简示例，CSV 要包含 code,color,warehouse,quantity 列）
  document.getElementById('uploadBtn').addEventListener('click', function(){
    document.getElementById('fileInput').click();
  });
  document.getElementById('fileInput').addEventListener('change', function(e){
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      const text = ev.target.result;
      // 极简 CSV 解析（以换行+逗号，第一行为 header）
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if (lines.length < 2) { alert('CSV 文件无数据'); return; }
      const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const items = [];
      for (let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        const obj = {};
        headers.forEach((h, idx)=> obj[h] = cols[idx] ? cols[idx].trim() : '');
        // 规范字段名 (code,color,warehouse,quantity)
        items.push({
          code: obj.code || obj.编号 || obj.id || obj['tile code'] || '',
          color: obj.color || obj.色号 || obj['colour'] || '',
          warehouse: obj.warehouse || obj.仓库 || obj['store'] || '',
          quantity: Number(obj.quantity || obj.数量 || 0)
        });
      }
      // 在本页作为 window.stockData 保存，方便后续搜索调用
      window.stockData = items;
      renderStockSearchResults(items, '#searchResults');
      document.getElementById('resultsInfo').textContent = `已导入 ${items.length} 条（来自 CSV）`;
    };
    reader.readAsText(f, 'utf-8');
  });

  // 初始：不自动显示数据（除非点击显示全部）
  // 如果你希望页面打开时默认展示全部，取消下一行注释：
  // renderStockSearchResults(sampleStock, '#searchResults');

  </script>
</body>
</html>
